# 任意追加質問機能 実装ドキュメント

## 概要
チャットボットが罪名・量刑の予測回答を提供した後、より詳細な分析を希望するユーザー向けに任意の追加質問を提示する機能を実装しました。

## 主な変更点

### 1. `src/chat.py`
- **新規定数追加**
  - `OPTIONAL_FOLLOW_UP_LABEL`: "任意追加確認"
  - `OPTIONAL_FOLLOW_UP_PREFIX`: ラベルのプレフィックス

- **新規クラス `OptionalFollowUpManager`**
  - 任意の追加質問を管理
  - 質問生成は2-3個に限定（簡潔性重視）
  - 既に回答済みの内容は質問しない

- **新規関数 `detect_continuation_intent`**
  - ユーザー入力が前回の話題の続きか新規相談かを判定
  - パターンマッチングとLLMによるハイブリッド判定

- **既存関数の拡張**
  - `predict_crime_and_punishment`: 任意質問付与対応
  - `simple_reply`: 任意質問付与対応
  - `reply`: 継続判定と詳細分析の実装

### 2. `src/predict_crime_type.py`
- `answer`関数に`add_optional_questions`パラメータを追加
- 回答生成後に任意質問を付与する機能を実装

## 動作フロー

### 通常の回答フロー
1. ユーザーが相談内容を入力
2. 必要に応じて深掘り質問（必須確認）を実施
3. 罪名・量刑の予測を回答
4. **回答の最後に任意の追加質問を付与**

### 任意質問の表示形式
```
==================================================

【任意追加確認】
より詳細な分析をご希望の場合は、以下について教えてください：

1. [簡潔な質問1]
2. [簡潔な質問2]

※これらは任意の質問です。回答いただかなくても問題ありません。
```

### 継続対話フロー
1. ユーザーが任意質問に回答
2. システムが「継続」と判定
3. 追加情報を考慮した詳細分析を実行
4. 詳細分析では任意質問を付与しない（無限ループ防止）

## 特徴

### ユーザビリティ
- 任意質問は完全にオプショナル（無視可能）
- 質問数を2-3個に限定（簡潔性重視）
- 「任意」であることを明示
- 本文の回答と明確に区別（区切り線使用）

### 技術的特徴
- 既存の深掘り質問機能に影響なし
- 新規相談と継続の自動判定
- 無限ループ防止（2回目の回答には質問を付与しない）
- エラーハンドリング（質問生成失敗時は付与しない）

## テスト

`test_optional_followup.py`でテスト可能：
```bash
python test_optional_followup.py
```

テスト内容：
- 任意質問の生成
- 継続判定ロジック
- 詳細分析の実行
- 新規相談の判定

## 今後の改善案
- 質問の質をさらに向上（より具体的で価値のある質問）
- ユーザーの回答履歴を学習して質問を最適化
- 質問数や表示形式のカスタマイズ機能